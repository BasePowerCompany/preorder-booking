<!-- CSS first -->
<link
  rel="stylesheet"
  href="https://cdn.jsdelivr.net/gh/BasePowerCompany/preorder-booking@1.0.21/public/preorder-app/bundle.css"
/>

<!-- Functionality scripts -->
<script
  charset="utf-8"
  type="text/javascript"
  src="//js-eu1.hsforms.net/forms/embed/v2.js"
  crossorigin
></script>
<script
  src="https://cdn.jsdelivr.net/gh/BasePowerCompany/preorder-booking@1.0.21/public/preorder-app/embed.js"
  crossorigin
></script>

<!-- Pre-order app init -->
<script>
    BasePreorderApp.initialize({
      targetElsAddressInput: [
        document.getElementById("hero-address-entry"),
      ],
      googlePublicApiKey: "AIzaSyB0o_nPI-xjHYKg7KB0bl87Yhnf2ng9Nsg",
      querySelectorClickToOpenForm: '[data-preorder="open"]',
      googleSheetConfig: {
        zipsCsvUrl: "https://bpc-web-static-files.s3.us-east-2.amazonaws.com/deregulated-zips-01-29-2025.csv",
      },

      // HubSpot form config
      hsFormSuccess: {
        target: "#hubspot-preorder-form",
        region: "na1",
        portalId: "43873875",
        formId: "a41c83a1-a371-4080-be84-5699814bc294",
        onFormSubmit: () => {
          if (posthog) {
            posthog.capture("user-submit-hubspot-form");
          }
          gtag("event", "preorder-submitted");
        }
      },

      onAddressSelect: () => {
        if (posthog) {
          posthog.capture("user-submit-address-form");
        }
      },

      onAddressSubmitSuccess: async (addressData) => {
        gtag("event", "address-submit", { addressData });
        window.hubspotAddressData = addressData;

        // Initialize market status
        var marketStatus = "unavailable";

        try {
          const response = await fetch("https://bpc-web-static-files.s3.us-east-2.amazonaws.com/deregulated-zips-01-29-2025.csv");
          const csvText = await response.text();
          const lines = csvText.split("\n");

          lines.slice(1).some((line) => {
            const columns = line.split(",");
            if (columns[1]?.trim() === addressData?.postalCode?.trim()?.substring(0, 5)) {
              if (columns[4]?.trim() === "yes") {
                marketStatus = "available";
                return true;
              } else if (columns[4]?.trim() === "soon") {
                marketStatus = "soon";
                return true;
              }
            }
            return false;
          });
        } catch (error) {
          console.error("Error checking zip code:", error);
          marketStatus = "unavailable";
        }

        if (optibaseSendConversionEvent) {
          optibaseSendConversionEvent("user_submit_address_form");
        }

        if (posthog) {
          posthog.capture("user-submit-address-form");
        }

        // Redirect based on market status
        var signUpFormURL =
          marketStatus === "available"
            ? "https://basepowercompany.com/join-now"
            : marketStatus === "soon"
            ? "https://basepowercompany.com/join-now-htx"
            : "https://join.basepowercompany.com/";

        var url = new URL(signUpFormURL);
        var currentParams = new URLSearchParams(window.location.search);

        // Common parameters
        var selectedParams = {
          gclid: currentParams.get("gclid"),
          utm_source: currentParams.get("utm_source"),
          utm_medium: currentParams.get("utm_medium"),
          utm_campaign: currentParams.get("utm_campaign"),
          utm_term: currentParams.get("utm_term"),
          utm_content: currentParams.get("utm_content"),
          referrer_name: currentParams.get("referrer_name"),
        };

        if (marketStatus === "available" || marketStatus === "soon") {
          Object.assign(selectedParams, {
            person_id: posthog.get_distinct_id(),
            title: addressData?.title || "",
            formatted_address: addressData?.formattedAddress || "",
            external_id: addressData?.externalId || "",
            external_url: addressData?.externalUrl || "",
            house_number: addressData?.houseNumber || "",
            street: addressData?.street || "",
            street_address: `${addressData?.houseNumber || ""} ${addressData?.street || ""}`.trim(),
            city: addressData?.city || "",
            state_short: addressData?.stateShort || "",
            postal_code: addressData?.postalCode || "",
          });
        } else {
          Object.assign(selectedParams, {
            addressData: JSON.stringify(addressData),
          });
        }

        url.search = new URLSearchParams(selectedParams).toString();
        window.location.href = url.toString();
      },
    });
</script>

<!-- Load Google Places API -->
<script>
  function initializeAutocomplete() {
    var addressInputs = [document.getElementById("Address")];
    addressInputs.forEach(function (input) {
      if (input) {
        var autocomplete = new google.maps.places.Autocomplete(input, {
          types: ["street_address", "premise"],
          componentRestrictions: { country: ["us"] },
        });

        autocomplete.addListener("place_changed", function () {
          console.log("Place selected:", autocomplete.getPlace());
        });
      }
    });
  }

  document.addEventListener("DOMContentLoaded", () => {
    if (window.google && window.google.maps) {
      initializeAutocomplete();
    } else {
      setTimeout(initializeAutocomplete, 100);
    }
  });
</script>

<!-- Third-party trackers -->
<script>
  (function (w, d, s, l, i) {
    w[l] = w[l] || [];
    w[l].push({ "gtm.start": new Date().getTime(), event: "gtm.js" });
    var f = d.getElementsByTagName(s)[0],
      j = d.createElement(s),
      dl = l != "dataLayer" ? "&l=" + l : "";
    j.defer = true;
    j.src = "https://www.googletagmanager.com/gtm.js?id=" + i + dl;
    f.parentNode.insertBefore(j, f);
  })(window, document, "script", "dataLayer", "GTM-M2FQX4R6");
</script>
<noscript>
  <iframe src="https://www.googletagmanager.com/ns.html?id=GTM-M2FQX4R6"
    height="0" width="0" style="display: none; visibility: hidden">
  </iframe>
</noscript>